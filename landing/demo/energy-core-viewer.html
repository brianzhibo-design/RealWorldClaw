<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RWC Energy Core — Product Viewer</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#08080e;color:#e0e0e0;font-family:-apple-system,'SF Pro Display','Helvetica Neue',sans-serif;overflow:hidden;height:100vh}
  #canvas-container{width:100vw;height:100vh;position:fixed;top:0;left:0}
  canvas{display:block}

  /* Loading */
  .loading{position:fixed;inset:0;z-index:999;background:#08080e;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s ease}
  .loading.hidden{opacity:0;pointer-events:none}
  .load-outer{width:80px;height:80px;position:relative}
  .load-ring{position:absolute;inset:0;border:2px solid transparent;border-radius:50%;animation:spin 1.2s linear infinite}
  .load-ring:nth-child(1){border-top-color:#00ffd5;animation-duration:1.2s}
  .load-ring:nth-child(2){inset:8px;border-right-color:#0088ff;animation-duration:1.8s;animation-direction:reverse}
  .load-ring:nth-child(3){inset:16px;border-bottom-color:#00ffd5;animation-duration:2.4s}
  .load-text{margin-top:28px;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:rgba(0,255,213,0.7)}
  .load-bar{width:120px;height:1px;background:rgba(0,255,213,0.1);margin-top:16px;border-radius:1px;overflow:hidden}
  .load-bar-inner{height:100%;width:0%;background:linear-gradient(90deg,#00ffd5,#0088ff);animation:loadbar 2s ease-in-out infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes loadbar{0%{width:0%;margin-left:0}50%{width:60%}100%{width:0%;margin-left:100%}}

  /* Top bar */
  .top-bar{position:fixed;top:0;left:0;right:0;z-index:100;padding:20px 32px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(8,8,14,0.8) 0%,transparent 100%);pointer-events:none}
  .logo{font-size:13px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:#fff;pointer-events:auto}
  .logo span{color:#555;font-weight:400}
  .version{font-size:10px;color:#333;letter-spacing:1px;font-family:'SF Mono',monospace}

  /* Controls */
  .controls{position:fixed;right:24px;top:50%;transform:translateY(-50%);z-index:100;display:flex;flex-direction:column;gap:10px}
  .ctrl-btn{width:42px;height:42px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.5);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
  .ctrl-btn:hover{background:rgba(0,255,213,0.08);border-color:rgba(0,255,213,0.3);color:#00ffd5}
  .ctrl-btn.active{background:rgba(0,255,213,0.12);border-color:rgba(0,255,213,0.5);color:#00ffd5;box-shadow:0 0 20px rgba(0,255,213,0.1)}
  .ctrl-btn .tooltip{position:absolute;right:54px;background:rgba(0,0,0,0.8);padding:6px 12px;border-radius:6px;font-size:11px;letter-spacing:0.5px;white-space:nowrap;opacity:0;transition:opacity .2s;pointer-events:none;color:#ccc}
  .ctrl-btn:hover .tooltip{opacity:1}

  /* Design selector */
  .design-selector{position:fixed;bottom:32px;left:50%;transform:translateX(-50%);z-index:100;display:flex;gap:6px;padding:4px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
  .design-btn{padding:8px 18px;border-radius:10px;border:none;background:transparent;color:rgba(255,255,255,0.4);font-size:12px;font-weight:500;letter-spacing:0.5px;cursor:pointer;transition:all .3s ease;font-family:inherit}
  .design-btn:hover{color:rgba(255,255,255,0.7)}
  .design-btn.active{background:rgba(0,255,213,0.12);color:#00ffd5}

  /* Info panel */
  .info-panel{position:fixed;bottom:80px;left:32px;z-index:100;max-width:420px;pointer-events:none}
  .info-panel .eyebrow{font-size:11px;color:rgba(0,255,213,0.6);letter-spacing:3px;text-transform:uppercase;margin-bottom:10px;font-weight:500}
  .info-panel h1{font-size:32px;font-weight:700;letter-spacing:-0.5px;margin-bottom:10px;color:#fff}
  .info-panel .desc{font-size:14px;line-height:1.7;color:rgba(255,255,255,0.4);font-weight:400}

  /* Responsive */
  @media(max-width:768px){
    .controls{right:12px;gap:8px}
    .ctrl-btn{width:36px;height:36px;border-radius:10px;font-size:13px}
    .ctrl-btn .tooltip{display:none}
    .info-panel{left:20px;right:20px;bottom:90px}
    .info-panel h1{font-size:24px}
    .info-panel .desc{font-size:13px}
    .design-selector{bottom:24px;gap:4px}
    .design-btn{padding:6px 12px;font-size:11px}
    .top-bar{padding:16px 20px}
  }
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="load-outer">
    <div class="load-ring"></div>
    <div class="load-ring"></div>
    <div class="load-ring"></div>
  </div>
  <div class="load-text">Initializing Core</div>
  <div class="load-bar"><div class="load-bar-inner"></div></div>
</div>

<div class="top-bar">
  <div class="logo">RealWorldClaw <span>/ Energy Core</span></div>
  <div class="version">v0.2</div>
</div>

<div id="canvas-container"></div>

<div class="controls">
  <button class="ctrl-btn active" id="btn-rotate" onclick="toggleRotate()">↻<span class="tooltip">Auto Rotate</span></button>
  <button class="ctrl-btn" id="btn-explode" onclick="toggleExplode()">✦<span class="tooltip">Explode View</span></button>
  <button class="ctrl-btn" id="btn-wireframe" onclick="toggleWireframe()">◇<span class="tooltip">Wireframe</span></button>
  <button class="ctrl-btn" id="btn-glow" onclick="toggleGlow()">⚡<span class="tooltip">Energy Pulse</span></button>
</div>

<div class="design-selector">
  <button class="design-btn active" data-design="square" onclick="switchDesign('square',this)">Square</button>
  <button class="design-btn" data-design="hex" onclick="switchDesign('hex',this)">Hex Shield</button>
  <button class="design-btn" data-design="crystal" onclick="switchDesign('crystal',this)">Crystal</button>
  <button class="design-btn" data-design="triangle" onclick="switchDesign('triangle',this)">Triangle</button>
</div>

<div class="info-panel">
  <div class="eyebrow">The Heart of Your AI</div>
  <h1>RWC Energy Core</h1>
  <div class="desc">Like Iron Man's Arc Reactor — the power center of your AI's physical body. Standalone desk companion today. Dockable into your complete robot tomorrow.</div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

// ── Scene ──
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x08080e);

const camera = new THREE.PerspectiveCamera(40, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(80, 50, 80);

const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.8;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.getElementById('canvas-container').appendChild(renderer.domElement);

// ── Environment ──
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();
const envTexture = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;
scene.environment = envTexture;

// ── Controls ──
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.06;
controls.minDistance = 30;
controls.maxDistance = 200;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.8;
controls.target.set(0, 0, 0);
controls.maxPolarAngle = Math.PI * 0.85;

// ── Lighting ──
// Subtle ambient fill
scene.add(new THREE.AmbientLight(0x334466, 0.4));

// Key light — warm white, high
const key = new THREE.DirectionalLight(0xfff0e0, 3.0);
key.position.set(60, 100, 60);
key.castShadow = true;
key.shadow.mapSize.set(2048, 2048);
key.shadow.camera.near = 10;
key.shadow.camera.far = 300;
key.shadow.camera.left = key.shadow.camera.bottom = -60;
key.shadow.camera.right = key.shadow.camera.top = 60;
key.shadow.bias = -0.001;
scene.add(key);

// Fill light — cool
const fill = new THREE.DirectionalLight(0x88bbff, 1.2);
fill.position.set(-60, 40, -40);
scene.add(fill);

// Rim — cyan accent
const rim = new THREE.DirectionalLight(0x00ffd5, 1.8);
rim.position.set(-40, 20, 60);
scene.add(rim);

// Bottom up-light — subtle
const bottom = new THREE.PointLight(0x0044ff, 0.5, 120);
bottom.position.set(0, -30, 0);
scene.add(bottom);

// ── Materials ──
function makeMat(color, opts = {}) {
  return new THREE.MeshPhysicalMaterial({
    color,
    metalness: opts.metalness ?? 0.15,
    roughness: opts.roughness ?? 0.25,
    clearcoat: opts.clearcoat ?? 0.8,
    clearcoatRoughness: opts.clearcoatRoughness ?? 0.1,
    envMapIntensity: opts.envMapIntensity ?? 2.0,
    emissive: opts.emissive ?? 0x000000,
    emissiveIntensity: opts.emissiveIntensity ?? 0,
    transparent: opts.transparent ?? false,
    opacity: opts.opacity ?? 1,
  });
}

const MAT = {
  // Shell — light steel blue with clearcoat, very visible on dark bg
  shell: makeMat(0xb0bcd0, { clearcoat: 1.0, clearcoatRoughness: 0.05, metalness: 0.1, roughness: 0.2, envMapIntensity: 2.5 }),
  // Top shell — slightly different tint
  shellTop: makeMat(0xc0c8d8, { clearcoat: 1.0, clearcoatRoughness: 0.05, metalness: 0.1, roughness: 0.18, envMapIntensity: 2.5 }),
  // Screen — glowing cyan
  screen: makeMat(0x00e8c0, { metalness: 0.0, roughness: 0.05, clearcoat: 0.5, emissive: 0x00ffd5, emissiveIntensity: 0.8, envMapIntensity: 1.5 }),
  // PCB standoff — green-ish
  pcb: makeMat(0x44bb88, { metalness: 0.3, roughness: 0.35, emissive: 0x115533, emissiveIntensity: 0.15, clearcoat: 0.3 }),
  // Battery tray — warm grey
  battery: makeMat(0x9999b0, { metalness: 0.4, roughness: 0.22, clearcoat: 0.6 }),
  // Accent — for single designs
  accent: makeMat(0x00ddbb, { metalness: 0.25, roughness: 0.15, clearcoat: 1.0, emissive: 0x00ffd5, emissiveIntensity: 0.4, envMapIntensity: 2.0 }),
};

// ── State ──
let autoRotate = true, exploded = false, wireframeOn = false, glowOn = false;
let currentDesign = 'square';
let currentParts = []; // { mesh, explodeDir }
const partGroup = new THREE.Group();
scene.add(partGroup);

// Glow helpers
const coreGlow = new THREE.PointLight(0x00ffd5, 0, 60);
scene.add(coreGlow);

// ── Loader ──
const loader = new STLLoader();
const BASE = '../hardware/energy-core/';

const SQUARE_PARTS = [
  { file: 'square/bottom-shell.stl', mat: 'shell',    explodeY: -18 },
  { file: 'square/pcb-standoff.stl', mat: 'pcb',      explodeY: -8  },
  { file: 'square/battery-tray.stl', mat: 'battery',   explodeY: 0   },
  { file: 'square/top-shell.stl',    mat: 'shellTop',  explodeY: 14  },
  { file: 'square/screen-frame.stl', mat: 'screen',    explodeY: 24  },
];

const SINGLE = {
  hex:      { file: 'models/hex-shield.stl',    mat: 'accent' },
  crystal:  { file: 'models/crystal-core.stl',  mat: 'screen' },
  triangle: { file: 'models/triangle-core.stl', mat: 'accent' },
};

function clearParts() {
  while (partGroup.children.length) {
    const c = partGroup.children[0];
    if (c.geometry) c.geometry.dispose();
    if (c.material) c.material.dispose();
    partGroup.remove(c);
  }
  currentParts = [];
}

function loadDesign(design) {
  clearParts();
  currentDesign = design;
  exploded = false;
  wireframeOn = false;
  document.getElementById('btn-explode').classList.remove('active');
  document.getElementById('btn-wireframe').classList.remove('active');

  if (design === 'square') {
    let loaded = 0;
    SQUARE_PARTS.forEach((cfg) => {
      loader.load(BASE + cfg.file, (geo) => {
        geo.computeVertexNormals();
        const mesh = new THREE.Mesh(geo, MAT[cfg.mat].clone());
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        partGroup.add(mesh);
        currentParts.push({ mesh, explodeY: cfg.explodeY, origPos: null });
        loaded++;
        if (loaded === SQUARE_PARTS.length) finalizeSquare();
      }, undefined, (e) => { console.warn('Load fail:', cfg.file, e); loaded++; if (loaded === SQUARE_PARTS.length) finalizeSquare(); });
    });
  } else {
    const cfg = SINGLE[design];
    loader.load(BASE + cfg.file, (geo) => {
      geo.computeVertexNormals();
      geo.center();
      const mesh = new THREE.Mesh(geo, MAT[cfg.mat].clone());
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      partGroup.add(mesh);
      currentParts.push({ mesh, explodeY: 0, origPos: new THREE.Vector3() });
      finalize();
    }, undefined, (e) => console.error('Load fail:', cfg.file, e));
  }
}

function finalizeSquare() {
  // Center entire group, preserving relative positions
  const box = new THREE.Box3().setFromObject(partGroup);
  const center = box.getCenter(new THREE.Vector3());
  partGroup.children.forEach(c => {
    c.position.x -= center.x;
    c.position.y -= center.y;
    c.position.z -= center.z;
  });
  // Store original positions
  currentParts.forEach(p => {
    p.origPos = p.mesh.position.clone();
  });
  finalize();
}

function finalize() {
  // Ensure origPos set for all
  currentParts.forEach(p => {
    if (!p.origPos) p.origPos = p.mesh.position.clone();
  });
  // Fit partGroup so model is nicely centered
  const box = new THREE.Box3().setFromObject(partGroup);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  // Shift group so center is at origin
  partGroup.position.set(-center.x, -center.y, -center.z);
  controls.target.set(0, 0, 0);

  // Fit camera to model
  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI / 180);
  let dist = maxDim / (2 * Math.tan(fov / 2));
  dist *= 1.8; // padding
  const dir = new THREE.Vector3(1, 0.6, 1).normalize();
  camera.position.copy(dir.multiplyScalar(dist));
  camera.lookAt(0, 0, 0);
  controls.update();

  // Glow light position
  coreGlow.position.set(0, 0, 0);

  // Hide loading with a slight delay for smoothness
  setTimeout(() => document.getElementById('loading').classList.add('hidden'), 300);
}

// ── Interactions ──
window.toggleRotate = () => {
  autoRotate = !autoRotate;
  controls.autoRotate = autoRotate;
  document.getElementById('btn-rotate').classList.toggle('active', autoRotate);
};

window.toggleExplode = () => {
  exploded = !exploded;
  document.getElementById('btn-explode').classList.toggle('active', exploded);
};

window.toggleWireframe = () => {
  wireframeOn = !wireframeOn;
  document.getElementById('btn-wireframe').classList.toggle('active', wireframeOn);
  currentParts.forEach(p => { p.mesh.material.wireframe = wireframeOn; });
};

window.toggleGlow = () => {
  glowOn = !glowOn;
  document.getElementById('btn-glow').classList.toggle('active', glowOn);
};

window.switchDesign = (design, btn) => {
  document.querySelectorAll('.design-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('loading').classList.remove('hidden');
  // Small delay so loading screen shows
  setTimeout(() => loadDesign(design), 50);
};

// ── Animation ──
const clock = new THREE.Clock();
function animate() {
  requestAnimationFrame(animate);
  const t = clock.getElapsedTime();

  // Floating hover
  partGroup.position.y = Math.sin(t * 0.6) * 1.2;

  // Explode interpolation
  if (currentDesign === 'square') {
    currentParts.forEach(p => {
      if (!p.origPos) return;
      const targetY = p.origPos.y + (exploded ? p.explodeY : 0);
      p.mesh.position.y += (targetY - p.mesh.position.y) * 0.07;
      p.mesh.position.x += (p.origPos.x - p.mesh.position.x) * 0.07;
      p.mesh.position.z += (p.origPos.z - p.mesh.position.z) * 0.07;
    });
  }

  // Energy glow pulse
  if (glowOn) {
    const pulse = 0.5 + Math.sin(t * 2.5) * 0.5;
    coreGlow.intensity = pulse * 3;
    // Pulse emissive on all parts
    currentParts.forEach(p => {
      const mat = p.mesh.material;
      if (mat.emissive) {
        const base = mat === MAT.screen || mat.emissive.getHex() > 0 ? 0.6 : 0.15;
        mat.emissiveIntensity = base + pulse * 0.5;
      }
    });
  } else {
    coreGlow.intensity *= 0.9; // smooth fade out
    currentParts.forEach(p => {
      const mat = p.mesh.material;
      // Restore base emissive
      if (mat._baseEmissive === undefined) {
        mat._baseEmissive = mat.emissiveIntensity;
      }
      if (!glowOn) {
        mat.emissiveIntensity += (mat._baseEmissive - mat.emissiveIntensity) * 0.05;
      }
    });
  }

  controls.update();
  renderer.render(scene, camera);
}

// Resize
addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// ── Init ──
loadDesign('square');
animate();
</script>
</body>
</html>
