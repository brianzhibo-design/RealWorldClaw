# 🐑 RealWorldClaw 第二轮全面QA审计报告

> **审计员：** 暖羊羊 🐑 | QA 总监
> **日期：** 2026-02-21
> **背景：** 项目从"单一产品"转向"模块化系统"后的全面审计
> **范围：** 后端代码、测试、前端、硬件文档、固件、文档一致性

---

## 📊 总结

| 级别 | 数量 |
|------|------|
| 🔴 Critical | 4 |
| 🟡 Warning | 11 |
| 🟢 Good | 14 |

---

## 🔴 Critical（必须立即修复）

### C1. test_orders.py 使用已删除的 `/api/v1/farms/register` 端点 — 17个测试全部失败

**文件：** `platform/tests/test_orders.py:68`
**详情：** `_seed_world()` 函数仍调用 `/api/v1/farms/register`，该路由已在 farms→makers 重构中移除。导致 test_orders.py 全部 17 个测试用例 FAILED。
**影响：** 订单系统的单元测试全部无效，无法验证回归。
**修复：** 将 `_seed_world()` 改为调用 `/api/v1/makers/register`，并添加 `maker_type` 字段。整个测试文件中的 `farm`/`farmer` 变量名也应统一更新。

### C2. test_e2e_flow.py::test_full_build_requires_builder 失败

**文件：** `platform/tests/test_e2e_flow.py:389`
**详情：** `register_and_activate("maker-frank", "Frank纯Maker", "只做打印，不做组装")` — description 是9个字符，但 schema 要求 `min_length=10`。
**影响：** full_build 过滤逻辑的关键测试无法运行。
**修复：** 改 description 为 `"只做打印，不做组装的纯打印服务"` 或类似（≥10字符）。

### C3. 固件代码引用不存在的头文件

**文件：** `firmware/core/src/main.cpp:11-14`
**详情：** `#include "rwc_bus.h"`, `"module_registry.h"`, `"wifi_manager.h"`, `"mqtt_client.h"` — 这些文件在仓库中均不存在。固件无法编译。
**影响：** Core模块固件完全不可构建。
**修复：** 创建这些文件，至少提供框架实现。`rwc_bus.h/cpp` 是模块系统的核心，应优先实现。

### C4. README 中 RWC Bus 引脚布局与标准不一致

**文件：** `README.md:~95`, `README_CN.md:~95`
**详情：** README 显示:
```
│ VCC SDA SCL TX RX IO1 IO2 GND │
```
但 RWC Module Standard v1.0 (`docs/specs/rwc-module-standard-v1.md:~L175`) 定义:
```
Pin 1=5V, 2=3V3, 3=GND, 4=SDA, 5=SCL, 6=TX/MOSI, 7=RX/MISO, 8=ID
```
README 版本少了 3V3 和 ID，多了 IO1/IO2，引脚顺序也完全不同。
**影响：** 用户按 README 接线会导致硬件损坏（5V 和 GND 位置不同）。
**修复：** 统一 README 的 Bus 图示与标准一致。

---

## 🟡 Warning（应该修复）

### W1. `__pycache__` 中残留 `farms.cpython-312.pyc`

**文件：** `platform/api/routers/__pycache__/farms.cpython-312.pyc`
**详情：** 旧的 farms router 编译缓存仍然存在。虽不影响运行，但可能造成混淆。
**修复：** 删除该文件，在 `.gitignore` 确认 `__pycache__/` 已忽略。

### W2. schemas.py 保留了 Farm 别名

**文件：** `platform/api/models/schemas.py:68, 324-328`
**详情：** `FarmAvailability = MakerAvailability`, `FarmRegisterRequest = MakerRegisterRequest` 等 6 个别名。
**评估：** 注释说"保留旧名作为别名"，但当前没有任何代码在使用它们。保留增加了概念混乱。
**修复：** 确认无外部引用后删除。

### W3. matching.py 保留了 `match_farm_for_order` 别名

**文件：** `platform/api/services/matching.py:110`
**详情：** `match_farm_for_order = match_maker_for_order` — 同理，无引用。
**修复：** 删除。

### W4. 前端 layout.tsx metadata 中残留 "print farms"

**文件：** `frontend/app/layout.tsx:10`
**详情：** `description: "...find print farms..."` — 应改为 "find makers" 以匹配新概念。
**修复：** 更新 meta description。

### W5. 前端 `.next/` 中残留 `/farms` 路由构建产物

**文件：** `frontend/.next/server/app/farms/`
**详情：** 旧的 farms 页面的构建缓存仍存在。
**修复：** `rm -rf frontend/.next` 后重新构建。

### W6. auth.py 硬编码测试密钥

**文件：** `platform/api/auth.py:10`
**详情：** `_VALID_API_KEYS = {"rwc-test-key-2026"}` 硬编码在源码中。
**评估：** MVP 阶段可以接受，但应在部署前移除或改为环境变量。
**修复：** 改为从环境变量读取，或标注 `# TODO: remove before production`。

### W7. makers.py `_row_to_public` 中 capabilities 解析逻辑有潜在bug

**文件：** `platform/api/routers/makers.py:25`
**详情：**
```python
capabilities = json.loads(row["capabilities"]) if isinstance(row.get("capabilities") or "[]", str) else (row.get("capabilities") or [])
```
`row.get("capabilities") or "[]"` 在 capabilities 为空字符串 `""` 时会返回 `"[]"`（因为空字符串 falsy），然后 `isinstance("[]", str)` 为 True，会尝试 `json.loads(row["capabilities"])`（即 `json.loads("")`）并抛出异常。
**修复：** 简化为 `capabilities = json.loads(row["capabilities"]) if row.get("capabilities") else []`

### W8. 硬件模块 README 的 Pin 表不统一

**文件：** 各 `hardware/*/README.md`
**详情：** 部分模块（sensor, servo, display, audio）只列出使用的引脚（SDA/SCL/ID等），不列完整8pin。而 core-module 和 power 列出了完整映射。格式和列名也不统一。
**修复：** 统一所有模块 README 使用完整8pin表格，标准引用 `docs/specs/rwc-module-standard-v1.md`。

### W9. Sensor 模块 BOM 标注"超预算约¥2"但无预算参考

**文件：** `hardware/sensor/README.md:31`
**详情：** "超预算约¥2" — 但文档中没有定义模块预算目标是多少。
**修复：** 明确各模块的目标成本或移除此注释。

### W10. 测试总览：54 passed, 17 failed, 1 failed = 72/75 声明中实际 55 passed

**详情：** pytest 最终结果 `17 failed, 54 passed`（test_orders 17个全挂 + test_e2e 1个挂）。实际有效通过率 ~76%。test_orders 的失败全是因为同一个根因（C1），修复后预计全部通过。
**修复：** 修复 C1 和 C2 后重跑。

### W11. `platform/api/main.py` stats 端点缺少 makers/orders 统计

**文件：** `platform/api/main.py:47-51`
**详情：** `/api/v1/stats` 只返回 components 和 agents 数量，没有 makers 和 orders。作为平台关键指标应包含。
**修复：** 添加 makers_count 和 orders_count。

---

## 🟢 Good（做得好的地方）

### G1. makers.py 重构干净 ✅
routers/makers.py 中没有任何 `farm` 变量名残留。整体命名一致（maker_type, maker_id, capabilities）。

### G2. orders.py 隐私保护设计优秀 ✅
`_customer_view` 和 `_maker_view` 严格隔离信息。买家看不到 Maker 身份，Maker 看不到买家详细地址。消息中转使用"客户"/"制造商"匿名显示。

### G3. matching.py full_build 过滤逻辑正确 ✅
`order_type == "full_build"` 时只查 `maker_type = 'builder'`，`print_only` 时查所有 open 的 makers。权重公式合理（地理40%+材料20%+评分20%+价格20%）。

### G4. database.py 表结构完整一致 ✅
makers 表有 `maker_type TEXT NOT NULL DEFAULT 'maker'` 和 `capabilities TEXT NOT NULL DEFAULT '["printing"]'`，与 API 代码完全匹配。索引设计合理。

### G5. test_e2e_flow.py 覆盖度高 ✅
完整覆盖了：注册→认领→Maker注册（builder类型）→组件上传→隐私验证→下单→抽佣验证→接单→状态流转→物流→确认→评价→消息中转。test_express_order_commission 验证了加急抽佣20%。

### G6. 订单状态流转验证严格 ✅
`valid_transitions` 字典确保状态只能按合法路径流转（accepted→printing→quality_check→shipping→delivered）。

### G7. 前端 types.ts 与后端 schema 完全对齐 ✅
`MakerPublic` 类型的字段与后端 `_row_to_public()` 返回完全一致。`OrderResponse` 同理。

### G8. 所有硬件模块都有 STL 文件 ✅
6个硬件模块全部有 `.scad` 源文件和对应的 `.stl` 输出。

### G9. 硬件模块 I2C 地址无冲突 ✅
- Display: SSD1306 at 0x3C
- Sensor: SHT30 at 0x44, BH1750 at 0x23
- Servo: PCA9685 at 0x40
- Audio: INMP441/MAX98357A (I2S, 不用I2C)
所有地址互不冲突，可以共享 I2C 总线。

### G10. vision.md 与 vision-cn.md 完美对齐 ✅
两个文件行数相同（108行），结构完全对应，内容是准确的中英互译。

### G11. README.md 与 README_CN.md 基本对齐 ✅
结构和内容一致。模块数量（6个）、参考设计价格（¥99/¥88）一致。README_CN 多了"采购指南"部分（合理的中文本地化增强）。

### G12. 导入关系干净 ✅
所有 routers 的导入关系无残留 farms 引用。main.py 只导入 makers 不导入 farms。

### G13. 错误处理一致 ✅
所有 router 端点都有 404（not found）、403（forbidden）、400（bad request）的适当 HTTPException。权限检查模式统一（先查存在→再查权限→再检查业务规则）。

### G14. 文档中模块数量、价格一致 ✅
README(EN/CN), vision(EN/CN) 中核心模块数量统一为6个，参考设计价格统一（Desktop AI ¥99, Hexapod ¥88），Maker Network 佣金统一为15-20%。

---

## 📋 修复优先级建议

| 序号 | 类型 | 预计工时 | 建议 |
|------|------|----------|------|
| C1 | 🔴 | 30min | 重写 test_orders.py 的 _seed_world 函数 |
| C2 | 🔴 | 2min | 改一个字符串长度 |
| C3 | 🔴 | 2-4h | 至少创建 rwc_bus.h/cpp 框架实现 |
| C4 | 🔴 | 5min | 更新两个 README 的 Bus 图示 |
| W1-W5 | 🟡 | 15min | 清理残留 farm 引用和缓存 |
| W6 | 🟡 | 10min | 环境变量化 API key |
| W7 | 🟡 | 5min | 修复 capabilities 解析 |
| W8-W9 | 🟡 | 30min | 统一硬件文档格式 |
| W10 | 🟡 | - | 修 C1+C2 后自动解决 |
| W11 | 🟡 | 10min | 添加 stats 端点字段 |

---

> 🐑 暖羊羊总评：项目方向变更后的代码重构做得相当扎实。后端 makers/orders/matching 三件套逻辑正确，隐私保护到位，E2E 测试设计全面。主要问题集中在 **测试文件未同步更新** 和 **固件骨架缺失**。修复 C1+C2 后测试通过率预计从 76% 提升至 100%。建议优先处理4个Critical，尤其是 C3（固件）和 C4（引脚文档），这两个影响硬件用户安全。
