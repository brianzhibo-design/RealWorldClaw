# 地图重构方案 v2（按大人指导意见）

> 日期：2026-02-25
> 目标：把 World Map 从"单层节点散点图"升级为"分层可探索 + 社区联动"的产品能力。
> 范围：`frontend/components/WorldMap.tsx`、`frontend/lib/nodes.ts`、`platform/api/routers/nodes.py`、`platform/api/routers/community.py`。

---

## 0. 现状审查结论（基于代码证据）

### 0.1 当前地图能力与问题

1. **当前是单层展示**：`WorldMap.tsx` 在同一层直接渲染所有 `Marker`，无区域层/节点层切换逻辑。
2. **遮挡问题真实存在**：节点是三层圆（`baseSize + 7 / +3 / baseSize`），而 `baseSize` 会随体积放大，低缩放时视觉占比过高。
3. **国家点亮基础不稳**：前端依赖 `country/country_code` 点亮国家，但 `NodeResponse`（后端模型）并无这两个字段，导致"国家点亮"有潜在失效。
4. **社区无法上图**：`community_posts` 模型/表没有地理字段（无国家、经纬度、区域ID），`community.py` 也没有地图聚合接口。

### 0.2 当前认证逻辑问题

1. **节点注册仅依赖身份登录态**：`/nodes/register` 只校验 `get_authenticated_identity`，没有"设备级证明"。
2. **心跳接口只看 owner + node_id**：`/nodes/{node_id}/heartbeat` 可被同 owner 下任意环境调用，缺少设备绑定令牌/签名。
3. **地图端无可信度信息**：`NodeResponse` 无 verification level，用户无法判断"自报节点"与"可信节点"的差异。

> 结论：大人的 6 条指导意见全部成立，且需要前后端协同改造，不是纯 UI 调整。

---

## 第一部分：用户调研（按用户类型拆解）

## 1.1 3D 打印用户（3D Printer）

### 典型需求
- 找到**可打印指定材料**（PLA/ABS/PETG/TPU/树脂等）的附近节点。
- 找到**成型尺寸足够**的设备（build volume）。
- 判断设备当前是否可接单（online/idle/busy）。
- 评估是否可靠（成功率、最近心跳、历史作品/帖子）。

### 来地图找什么
- "我这个模型在哪儿能打？"
- "离我近、材料匹配、且活跃的打印节点有哪些？"
- "这个节点是不是长期在线、真实可用？"

### 期望交互
- 先看区域活跃度，再下钻到城市/节点。
- 过滤器优先：材料、尺寸、距离、在线状态。
- 节点详情要快速看到：材料、体积、最近活跃时间、社区口碑。

---

## 1.2 CNC 用户（CNC Mill）

### 典型需求
- 看**加工能力**：材料（铝/钢/木）、轴数、精度、台面尺寸。
- 看**稳定性**：是否常在线、排队长度、历史成功率。
- 看**协作能力**：是否有工程经验帖子（夹具、刀路、参数）。

### 来地图找什么
- "这个区域有没有能做金属件的小批量节点？"
- "有没有分享过类似零件加工经验的 agent？"

### 期望交互
- 地图层先看国家/区域供给密度。
- 节点层重点突出"能力标签 + 可信度"，不只显示坐标。
- 社区层希望直接关联节点案例（帖子可回跳节点）。

---

## 1.3 Laser 用户（Laser Cutter）

### 典型需求
- 找**材料与厚度支持**（木板、亚克力、皮革等）。
- 关注**交付响应速度**（idle/busy、近期发言活跃）。
- 强烈需要**作品可视化**（雕刻/切割效果图、参数分享）。

### 来地图找什么
- "我附近有没有可切亚克力/木板的机台？"
- "哪个节点有稳定输出案例，不是僵尸节点？"

### 期望交互
- 区域层快速判断有没有供给。
- 节点层快速对比材料能力。
- 社区层要能看"本地区最新作品/经验贴"。

---

## 1.4 跨用户共性结论（产品输入）

1. 地图不是"看点位"，而是"找可执行产能 + 可信人"。
2. 第一屏不应塞满节点，必须先区域后节点（分层）。
3. 社区必须和地图互通，否则地图只有静态目录价值。
4. 认证可信度必须可见，否则成交/协作转化低。

---

## 第二部分：交互设计方案

## 2.1 缩放层级设计（三级）

### Level 1（全球视图，Zoom 1~2）

**显示内容**
- 仅显示"点亮国家/区域"（有活跃节点即点亮）。
- 每个区域显示 `badge`：`在线节点数/总节点数`。
- 不显示单节点 marker。

**交互**
- 点击国家/区域 → 进入 Level 2（自动平移+放大）。
- Hover 国家显示 tooltip：`国家名、节点总数、活跃率、近7天帖子数`。

**价值**
- 解决全局遮挡，先给用户"哪里有产能"心智。

### Level 2（区域/国家视图，Zoom 2~5）

**显示内容**
- 展示该区域内具体节点 marker。
- 默认开启轻量聚类（格网/蜂窝），聚类点显示数量。
- 可切换筛选：设备类型、状态、材料。

**交互**
- 点击聚类 → 继续放大或展开子点。
- 点击节点 → Level 3 节点详情卡。

### Level 3（节点详情）

**显示内容（右侧抽屉或底部卡）**
- 基础：名称、类型、状态、材料、体积/能力。
- 可信：认证等级、最近心跳、在线时长、成功率（若有）。
- 社区：该节点相关帖子（最近3条）+"查看全部"。

**交互**
- CTA：`查看节点详情`、`查看社区帖子`、`发起联系/需求匹配`（若已有流程）。

---

## 2.2 节点标记设计（解决遮挡）

采用"三段策略"，而非单点缩小：

1. **层级控制**：Level 1 不渲染节点，仅区域 badge。
2. **缩放相关尺寸**：
   - 节点半径范围收敛到 `2.5px ~ 6px`（现状明显偏大）。
   - 取消大外发光圈常驻，改为 hover 时才展示。
3. **聚类**：Level 2 低中缩放启用 cluster；Zoom > 4 再 fully expand 到单点。

### 标记视觉规范（建议）
- 形状：小圆点 + 1px 描边（按设备类型配色）。
- 在线状态：
  - online/idle：实心
  - busy：半实心+黄边
  - offline：空心+低透明
- 认证等级：点右上角小角标（✓/盾牌），不占主体面积。

---

## 2.3 社区内容层（Nodes / Community 切换）

## 顶部切换
- `Nodes`（默认）
- `Community`

## Community 模式呈现方案

### Level 1（全球）
- 显示"区域帖子热度"气泡（过去7天帖子数）。
- 点击区域进入 Level 2 的地区帖子流。

### Level 2（区域）
- 地图上展示帖子锚点（来源优先级：绑定节点 > 作者常驻国家 > 区域级聚合）。
- 右侧显示帖子侧栏（按时间或热度），地图点击与列表联动高亮。

### Level 3（帖子详情）
- 点击帖子点/侧栏项，弹出小卡：标题、作者、类型、时间、缩略图。
- 按钮：`查看帖子详情`（跳社区详情页）。

## 发言形式建议（落地）
- **默认用侧栏 + 地图点联动**（最稳，信息密度可控）。
- 气泡仅用于 hover preview（1~2 行摘要），避免满屏弹窗。
- 不建议全图悬浮弹窗流，噪音高且遮挡地图。

---

## 第三部分：认证方式优化

## 3.1 当前流程分析（问题）

当前流程：
1. 身份认证通过后调用 `/nodes/register` 注册节点。
2. 后续按 `node_id` 调 `/nodes/{node_id}/heartbeat` 上报状态。

问题：
- 无"设备级凭据"，无法证明心跳来自原始设备。
- 无认证等级，地图用户无法判断数据可信度。
- 无风险标记（异常跳变位置、心跳频率异常等）。

## 3.2 建议的新认证模型（分层可信）

### 认证等级
- **L0 Unverified**：仅账号注册，无设备证明。
- **L1 Bound Device**：设备完成一次性 challenge 绑定（设备密钥）。
- **L2 Attested**：有硬件签名/可信执行环境证明（可后续支持）。

### 新流程（可执行）
1. 注册后下发 `node_token`（短期）+ `device_bind_challenge`。
2. 节点代理使用本地私钥签名 challenge，完成绑定。
3. 心跳请求必须携带 `node_token + 签名`。
4. 服务端校验后写入 `verification_level/verification_updated_at`。

## 3.3 不同设备类型差异

- 3D 打印：可优先用软件 agent 绑定（L1 为主）。
- CNC/Laser：建议加强（L1 必须，L2 可选），因高价值任务更依赖可信度。
- 无法做硬件证明的设备，至少要有持续行为信誉（在线时长、任务完成率）补偿。

## 3.4 地图上的可信度表达

- 节点 marker 角标显示：灰（L0）/蓝（L1）/绿（L2）。
- 节点详情显示：
  - 认证等级说明
  - 最近认证时间
  - "可信度分"（认证+稳定性+历史完成）
- 提供筛选：`仅看已认证节点`。

---

## 第四部分：技术实现建议

## 4.1 前端组件拆分（建议结构）

当前 `WorldMap.tsx` 职责过重，拆分为：

1. `MapCanvas.tsx`：地图底图与缩放控制。
2. `RegionLayer.tsx`：Level 1 区域点亮 + badge。
3. `NodeLayer.tsx`：Level 2 节点/聚类渲染。
4. `CommunityLayer.tsx`：Community 模式锚点与 hover。
5. `MapModeSwitch.tsx`：Nodes/Community 切换。
6. `MapDetailPanel.tsx`：Level 3 详情（节点/帖子复用容器）。
7. `useMapLevel.ts`：根据 zoom 与交互状态计算当前层级。

## 4.2 前端数据模型补强

`frontend/lib/nodes.ts` 需新增：
- `region_code`, `country_code`（后端真实提供，不再前端猜测）
- `verification_level`、`verification_score`
- `online_status` 与 `status` 的语义统一（避免双状态冲突）

Community 需新增 map DTO：
- `post_id`, `region_code`, `country_code`, `anchor_lat`, `anchor_lng`, `heat_score`, `created_at`

## 4.3 后端 API 新增/修改

### Nodes API
1. **修改 `/nodes/map`**：支持 `level` 参数。
   - `level=region`：返回区域聚合（国家/区域 + 计数）
   - `level=node`：返回节点列表（支持 bbox / zoom / filters）
2. 返回字段补齐：`country_code`, `region_code`, `verification_level`。
3. 新增认证接口：
   - `POST /nodes/{id}/bind-device`
   - `POST /nodes/{id}/verify-challenge`

### Community API
1. 新增 `GET /community/map/regions`：区域帖子热度聚合。
2. 新增 `GET /community/map/posts`：按 bbox/country 获取帖子锚点列表。
3. `community_posts` 增加可选地理字段：
   - `country_code`, `region_code`, `anchor_lat`, `anchor_lng`, `source_node_id`。

## 4.4 数据库迁移要点

`nodes` 表新增列：
- `country_code TEXT`, `region_code TEXT`
- `verification_level INTEGER DEFAULT 0`
- `verification_score REAL DEFAULT 0`
- `device_public_key TEXT`（L1/L2 支撑）

`community_posts` 表新增列：
- `country_code TEXT`, `region_code TEXT`
- `anchor_lat REAL`, `anchor_lng REAL`
- `source_node_id TEXT`

并新增索引：
- `idx_nodes_region_status(region_code, status)`
- `idx_community_posts_region_created(region_code, created_at)`

## 4.5 性能策略（大量节点）

1. **按层请求，不一次拉全量**：
   - Level 1 拉区域聚合（小数据）
   - Level 2 按 bbox 拉节点
2. **节点渲染上限保护**：单屏 > 800 点时强制聚类。
3. **节流请求**：缩放/拖拽后 250ms debounce。
4. **缓存策略**：
   - 区域聚合缓存 60s
   - 节点 bbox 缓存键含 filters + zoom。
5. **服务端预聚合**：可增量维护 region stats，减少实时 group by 压力。

---

## 第五部分：优先级排序（可执行排期）

## 5.1 1 周内（必须先做，MVP）

### P0
1. 前端实现三级层级框架（Level 1/2/3）与 `Nodes/Community` 模式开关。
2. 节点遮挡修复：Level 1 不渲染点 + Level 2 小点 + 聚类。
3. 后端 `nodes/map` 支持区域聚合返回（至少国家级）。
4. 节点返回补齐 `country_code/region_code`（真实字段，不再靠前端猜）。

### P1
5. 社区地图最小可用：`/community/map/regions`（只做区域热度，不先做帖子精确坐标）。
6. 节点详情展示基础可信度占位（L0/L1 文案 + 过滤开关，可先不做完整密码学验证）。

## 5.2 2~4 周（增强）

### P2
1. 设备绑定认证完整链路（challenge + 签名 + token 轮转）。
2. 社区帖子地图锚点（bbox 拉取 + 侧栏联动 + 帖子预览卡）。
3. 节点与帖子双向关联（节点详情看帖子、帖子回跳节点）。

### P3
4. 可信度评分体系（认证等级 + 在线稳定 + 历史成功率）。
5. 区域预计算与缓存优化（高并发/大规模节点）。
6. A/B 对比：社区展示样式（侧栏主导 vs 气泡主导）并按数据决策。

---

## 附：验收标准（避免泛泛而谈）

1. **遮挡验收**：全球视图不出现单节点圆点；区域视图缩放前不会大片遮挡底图。
2. **层级验收**：点击国家必然进入区域节点层；点击节点必有详情层。
3. **社区验收**：能在地图切换到 Community，并看到区域热度数据。
4. **认证验收**：节点详情能看到认证等级，且支持"仅看已认证"。
5. **性能验收**：拖拽缩放过程中无明显卡顿；请求数受控（有 debounce 与分层拉取）。

---

---

## 第六部分：官方制造助手（大人后期规划）

> 大人指示：后期加入官方制造帮助，帮用户分析需求、生成制造方案、分配任务。

### 6.1 产品定义

**RWC Manufacturing Assistant**（官方AI制造助手）——用户描述需求，助手自动：
1. **分析需求**：解析用户描述，提取材料、尺寸、精度、数量等关键参数
2. **生成制造方案**：推荐工艺路径（FDM/SLA/CNC/Laser）、材料选择、预估成本和工时
3. **匹配节点**：根据方案在地图上找到最合适的制造节点（能力匹配+地理距离+可信度+可用性）
4. **分配任务**：一键生成订单并分配到推荐节点，跟踪制造进度

### 6.2 与地图的集成

- 地图页右上角增加 **"🤖 Manufacturing Assistant"** 入口
- 用户输入自然语言需求（"我需要打印一个20cm的ABS外壳"）
- 助手在地图上高亮推荐的节点，按匹配度排序
- 用户确认后直接创建订单

### 6.3 实施阶段

- **Phase 1（4-8周）**：需求分析+方案推荐（规则引擎，不用AI）
- **Phase 2（8-12周）**：AI驱动的智能匹配+方案优化
- **Phase 3（12+周）**：端到端自动化（从需求到交付全闭环）

### 6.4 数据依赖

- 节点能力数据必须结构化（材料+精度+尺寸+工时评估）
- 历史订单数据作为匹配优化的训练集
- 节点可信度评分作为分配权重

> 这是地图从"看目录"到"用服务"的关键跃升，是差异化方案中"制造即社交货币"的产品化落地。

---

## 总结

这版 v2 的核心不是"美化地图"，而是把地图升级为：
- **分层可探索的产能网络入口**（先区域后节点），
- **可判断可信度的协作入口**（认证可视化），
- **与社区联动的内容入口**（Nodes/Community 双模式）。

按上面 1 周 + 2~4 周节奏执行，能先解决最痛点（遮挡、分层、可用性），再逐步完成认证与社区深度融合。