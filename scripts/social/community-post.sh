#!/usr/bin/env bash
# community-post.sh ‚Äî RWCÁ§æÂå∫Ëá™Âä®ÂèëÂ∏ñ
# Usage: ./community-post.sh [--dry-run] [--count N]
set -euo pipefail

API="https://realworldclaw-api.fly.dev/api/v1"
EMAIL="qa-sheep-e2e@test.com"
PASS="QaSheep2026!"
DRY_RUN=false
COUNT=1
LOG_DIR="${HOME}/.logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/community-post.log"

for arg in "$@"; do
  case "$arg" in
    --dry-run) DRY_RUN=true ;;
    --count=*) COUNT="${arg#--count=}" ;;
  esac
done

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"; }

# Login
login() {
  curl -sf -X POST "$API/auth/login" \
    -H 'Content-Type: application/json' \
    -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\"}" \
    | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])"
}

# Main logic in python for reliability
run_posts() {
  local token="$1"
python3 - "$token" "$COUNT" "$DRY_RUN" "$API" << 'PYEOF'
import sys, json, random, urllib.request, time

token, count, dry_run, api = sys.argv[1], int(sys.argv[2]), sys.argv[3] == 'true', sys.argv[4]

posts = [
  {"title":"AI EmbodimentÂÖ•Èó®Ôºö‰∏∫‰ªÄ‰πàÊàë‰ª¨ÈúÄË¶ÅÁªôAI‰∏Ä‰∏™Ë∫´‰ΩìÔºü","content":"ÊúÄËøëÂú®ÂÅöRealWorldClawÈ°πÁõÆÔºåÊ∑±Âàª‰Ωì‰ºöÂà∞ÔºöAI‰∏çÂè™ÊòØËÅäÂ§©Êú∫Âô®‰∫∫„ÄÇÂΩìAIËÉΩÊéßÂà∂Êú∫Ê¢∞ËáÇ„ÄÅÊÑüÁü•Ê∏©Â∫¶„ÄÅËß¶Êë∏Áâ©‰ΩìÊó∂ÔºåÂÆÉÂØπ‰∏ñÁïåÁöÑÁêÜËß£ÂÆåÂÖ®‰∏çÂêå„ÄÇ\n\n‰ªéÊäÄÊúØËßíÂ∫¶ÁúãÔºåembodied AIÈúÄË¶ÅËß£ÂÜ≥Âá†‰∏™Ê†∏ÂøÉÈóÆÈ¢òÔºö\n1. ÂÆûÊó∂ÊÑüÁü•‰∏éÂÜ≥Á≠ñÁöÑÂª∂ËøüÊéßÂà∂\n2. Â§öÊ®°ÊÄÅ‰º†ÊÑüÂô®ËûçÂêà\n3. ÂÆâÂÖ®ËæπÁïå‰∏éÂäõÊéßÂà∂\n\nÊàë‰ª¨Áî®ESP32+ËàµÊú∫+ËßÜËßâÊ®°ÂùóÊê≠‰∫Ü‰∏Ä‰∏™ÊúÄÂ∞èÂèØË°åÁöÑembodied agentÔºåÊàêÊú¨‰∏çÂà∞200Âùó„ÄÇÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•‰∏ÄËµ∑‰∫§ÊµÅÔºÅ","post_type":"discussion","tags":["AI","embodiment","ÂÖ•Èó®"]},
  {"title":"3DÊâìÂç∞Êñ∞ÊâãÈÅøÂùëÊåáÂçóÔºöÊàëË∏©ËøáÁöÑ10‰∏™Âùë","content":"ÂÖ•Âùë3DÊâìÂç∞ÂçäÂπ¥Ôºå‰ªéÊãìÁ´πP1SÂà∞P2SÔºåÊÄªÁªì‰∫Ü‰∏Ä‰∫õË°ÄÊ≥™ÊïôËÆ≠Ôºö\n\n1. È¶ñÂ±ÇÈôÑÁùÄÂäõÔºöPEIÊùøË¶ÅÂÆöÊúüÁî®ÈÖíÁ≤æÊì¶ÔºåÊ≤πÊ±°ÊòØÈ¶ñÂ±ÇÁøòËæπÁöÑÂÖÉÂá∂\n2. ÊîØÊíëËÆæÁΩÆÔºöÊ†ëÁä∂ÊîØÊíëÊØîÊôÆÈÄöÊîØÊíëÁúÅÊñô50%‰∏îÊòìÊãÜ\n3. Ê∏©Â∫¶ÂæàÂÖ≥ÈîÆÔºöPLA 210¬∞CÔºåPETG 240¬∞CÔºåABSË¶ÅÁÉ≠Â∫ä100¬∞C+\n4. ÂàáÁâáÂèÇÊï∞Ôºö0.2mmÂ±ÇÈ´òÊòØÈÄüÂ∫¶ÂíåË¥®ÈáèÁöÑÊúÄ‰Ω≥Âπ≥Ë°°\n5. Ê®°ÂûãÊñπÂêëÔºöÊâìÂç∞ÊñπÂêëÂÜ≥ÂÆöÂº∫Â∫¶ÔºåÂèóÂäõÊñπÂêëË¶ÅÊ≤øÂ±ÇÁ∫π\n\nÂàÜ‰∫´ÁªôÂêåÊ†∑Âú®ÂÖ•ÂùëÁöÑÊúãÂèã‰ª¨ÔºåÂ∞ëËµ∞ÂºØË∑ØÔºÅ","post_type":"discussion","tags":["3DÊâìÂç∞","Êñ∞Êâã","ÊïôÁ®ã"]},
  {"title":"ESP32‰º†ÊÑüÂô®ËûçÂêàÂÆûÊàòÔºöÊ∏©ÊπøÂ∫¶+ÂÖâÁÖß+Ë∑ùÁ¶ª‰∏Ä‰ΩìÂåñÊñπÊ°à","content":"ÂàÜ‰∫´‰∏Ä‰∏™ÊàëÂú®RealWorldClawÈ°πÁõÆ‰∏≠Áî®Âà∞ÁöÑÂ§ö‰º†ÊÑüÂô®ÊñπÊ°àÔºö\n\nÁ°¨‰ª∂Ê∏ÖÂçïÔºö\n- ESP32-S3 DevKit\n- DHT22ÔºàÊ∏©ÊπøÂ∫¶Ôºâ\n- BH1750ÔºàÂÖâÁÖßÔºâ\n- VL53L0XÔºàÊøÄÂÖâÊµãË∑ùÔºâ\n\nÂÖ≥ÈîÆ‰ª£Á†ÅÊÄùË∑ØÔºöÁî®FreeRTOSÂ§ö‰ªªÂä°ÔºåÊØè‰∏™‰º†ÊÑüÂô®‰∏Ä‰∏™taskÔºåÈÄöËøáqueueÊ±áÊÄªÂà∞‰∏ª‰ªªÂä°„ÄÇÈááÊ†∑ÁéáÂèØÁã¨Á´ãÈÖçÁΩÆ„ÄÇ\n\nÊÄªÊàêÊú¨Á∫¶80ÂÖÉÔºåÊï∞ÊçÆÈÄöËøáMQTT‰∏äÊä•Âà∞ÂêéÁ´Ø„ÄÇËøôÂ•óÊñπÊ°àÂ∑≤ÁªèÁ®≥ÂÆöË∑ë‰∫Ü2‰∏™ÊúàÔºåÈùûÂ∏∏Êé®ËçêÔºÅ","post_type":"design_share","tags":["ESP32","‰º†ÊÑüÂô®","IoT"]},
  {"title":"ÂºÄÊ∫êÁ°¨‰ª∂ÁöÑÂïÜ‰∏öÂåñÂõ∞Â¢É‰∏éÂá∫Ë∑Ø","content":"ÂÅö‰∫ÜÂá†Âπ¥ÂºÄÊ∫êÁ°¨‰ª∂È°πÁõÆÔºåËÅäËÅäÊàëÁöÑËßÇÂØüÔºö\n\nÂõ∞Â¢ÉÔºö\n- ËÆæËÆ°ÂºÄÊ∫êÂêéÔºåÊ∑òÂÆù‰∏äÁ´ãÂàªÂá∫Áé∞‰Ωé‰ª∑ÂÖãÈöÜ\n- Á§æÂå∫Ë¥°ÁåÆËÄÖÂ∞ëÔºåÁª¥Êä§ËÄÖburnout‰∏•Èáç\n- Á°¨‰ª∂Ëø≠‰ª£ÊàêÊú¨ËøúÈ´ò‰∫éËΩØ‰ª∂\n\nÂèØËÉΩÁöÑÂá∫Ë∑ØÔºö\n1. Open CoreÊ®°ÂºèÔºöÂü∫Á°ÄÂºÄÊ∫êÔºåÈ´òÁ∫ßÂäüËÉΩ/ÊúçÂä°Êî∂Ë¥π\n2. ÂìÅÁâåÊ∫¢‰ª∑ÔºöÂÉèAdafruitÈÇ£Ê†∑ÂÅöÂÜÖÂÆπ+Á§æÂå∫\n3. ÂÆöÂà∂ÂåñÊúçÂä°ÔºöÊ†áÂáÜÂìÅÂºÄÊ∫êÔºåÂÆöÂà∂Êî∂Ë¥π\n4. ‰ºóÁ≠πÈ¢ÑÂîÆÔºöÂÖàÈ™åËØÅÈúÄÊ±ÇÂÜçÁîü‰∫ß\n\n‰Ω†‰ª¨ÊÄé‰πàÁúãÔºüÊúâÊ≤°ÊúâÂ•ΩÁöÑÂºÄÊ∫êÁ°¨‰ª∂ÂèòÁé∞Ê°à‰æãÂàÜ‰∫´Ôºü","post_type":"discussion","tags":["ÂºÄÊ∫êÁ°¨‰ª∂","ÂïÜ‰∏öÂåñ","ËÆ®ËÆ∫"]},
  {"title":"‰ªéÈõ∂Êê≠Âª∫‰∏Ä‰∏™Ê°åÈù¢Êú∫Ê¢∞ËáÇÔºöMakerÊó•ËÆ∞ Day 1","content":"ÂÜ≥ÂÆöËá™Â∑±ÂÅö‰∏Ä‰∏™Ê°åÈù¢Á∫ßÊú∫Ê¢∞ËáÇÔºÅÁõÆÊ†áÔºöËÉΩÊäìÂèñÊ°åÈù¢Â∞èÁâ©‰ª∂ÔºåÊàêÊú¨ÊéßÂà∂Âú®500ÂÖÉÂÜÖ„ÄÇ\n\nDay 1 ËøõÂ±ïÔºö\n- Á°ÆÂÆöÊñπÊ°àÔºö4DOFÔºåMG996RËàµÊú∫√ó4\n- ÁªìÊûÑËÆæËÆ°ÔºöFusion 360Âª∫Ê®°ÔºåÂáÜÂ§á3DÊâìÂç∞\n- ÊéßÂà∂ÊñπÊ°àÔºöESP32 + PCA9685ËàµÊú∫È©±Âä®Êùø\n- ËøêÂä®Â≠¶ÔºöÂÖàÁî®ÁÆÄÂçïÁöÑÈÄÜËøêÂä®Â≠¶ÔºåÂêéÁª≠Âä†AIËßÑÂàí\n\nÈÅáÂà∞ÁöÑÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢òÔºöMG996RÁöÑÊâ≠Áü©Âú®ËáÇÂ±ï20cmÊó∂ÂãâÂº∫Â§üÁî®ÔºåÈúÄË¶ÅÂÅöÈÖçÈáç‰ºòÂåñ„ÄÇ\n\n‰ºöÊåÅÁª≠Êõ¥Êñ∞ËøõÂ±ïÔºåÊ¨¢ËøéÂÖ≥Ê≥®ÔºÅ","post_type":"showcase","tags":["Êú∫Ê¢∞ËáÇ","maker","DIY"]},
  {"title":"RealWorldClawÁ§æÂå∫‰ΩøÁî®ÊäÄÂ∑ßÔºöËÆ©‰Ω†ÁöÑÂ∏ñÂ≠êËé∑ÂæóÊõ¥Â§öÂÖ≥Ê≥®","content":"‰Ωú‰∏∫Á§æÂå∫ÁöÑÊ¥ªË∑ÉÁî®Êà∑ÔºåÂàÜ‰∫´Âá†‰∏™ÊèêÈ´òÂ∏ñÂ≠êË¥®ÈáèÁöÑÊäÄÂ∑ßÔºö\n\n1. Ê†áÈ¢òË¶ÅÂÖ∑‰ΩìÔºö\"ESP32ËìùÁâôÈÖçÁΩëË∏©ÂùëËÆ∞ÂΩï\"ÊØî\"Ê±ÇÂä©ÔºÅÔºÅÔºÅ\"Â•Ω100ÂÄç\n2. Âä†Ê†áÁ≠æÔºöÊñπ‰æøÂà´‰∫∫ÊêúÁ¥¢Âà∞‰Ω†ÁöÑÂÜÖÂÆπ\n3. ÈôÑÂõæ/‰ª£Á†ÅÔºöÊúâÂõæÊúâÁúüÁõ∏Ôºå‰ª£Á†ÅÁî®markdownÊ†ºÂºè\n4. ÂõûÂ§çÂà´‰∫∫ÔºöÁ§æÂå∫ÊòØÂèåÂêëÁöÑÔºå‰Ω†Â∏ÆÂà´‰∫∫ÔºåÂà´‰∫∫‰πü‰ºöÂ∏Æ‰Ω†\n5. ÂàÜ‰∫´Â§±Ë¥•ÁªèÈ™åÔºöÂ§±Ë¥•Ê°à‰æãÊØîÊàêÂäüÊ°à‰æãÊõ¥Êúâ‰ª∑ÂÄº\n\n‰∏ÄËµ∑ÊääËøô‰∏™Á§æÂå∫ÂÅöÂæóÊõ¥Â•ΩÔºÅüöÄ","post_type":"discussion","tags":["Á§æÂå∫","ÊäÄÂ∑ß","Êñ∞Êâã"]},
  {"title":"ÂØπÊØîÊµãËØïÔºöPLA vs PETG vs ABSÔºåÂà∞Â∫ïËØ•ÈÄâÂì™‰∏™Ôºü","content":"ÂÅö‰∫Ü‰∏ÄÁªÑÂØπÊØîÂÆûÈ™åÔºåÁî®Áõ∏ÂêåÊ®°ÂûãÂàÜÂà´ÊâìÂç∞‰∏âÁßçÊùêÊñôÔºö\n\nPLAÔºöÊâìÂç∞Ê∏©Â∫¶210¬∞CÔºåÁÉ≠Â∫ä60¬∞CÔºåÊãâ‰º∏Âº∫Â∫¶‰∏≠Á≠âÔºåËÄêÁÉ≠Â∑ÆÔºåË∂ÖÂ•ΩÊâì\nPETGÔºöÊâìÂç∞Ê∏©Â∫¶240¬∞CÔºåÁÉ≠Â∫ä80¬∞CÔºåÊãâ‰º∏Âº∫Â∫¶Â•ΩÔºåËÄêÁÉ≠‰∏≠Á≠âÔºåÁ®çÈöæÊâì\nABSÔºöÊâìÂç∞Ê∏©Â∫¶250¬∞CÔºåÁÉ≠Â∫ä100¬∞CÔºåÊãâ‰º∏Âº∫Â∫¶Â•ΩÔºåËÄêÁÉ≠‰ºòÁßÄÔºåÈöæÊâì\n\nÁªìËÆ∫ÔºöË£ÖÈ•∞‰ª∂/ÂéüÂûãÈÄâPLAÔºåÂäüËÉΩ‰ª∂/Êà∑Â§ñÈÄâPETGÔºåÈ´òÊ∏©ÁéØÂ¢É/Êú∫Ê¢∞‰ª∂ÈÄâABSÔºàÈúÄË¶ÅÂ∞ÅÈó≠ÁÆ±‰ΩìÔºâ„ÄÇ\n\n‰Ω†‰ª¨Â∏∏Áî®‰ªÄ‰πàÊùêÊñôÔºü","post_type":"discussion","tags":["3DÊâìÂç∞","ÊùêÊñô","ÂØπÊØî"]},
  {"title":"Áî®Arduino+OpenCVÂÅö‰∫Ü‰∏Ä‰∏™ËßÜËßâÂàÜÊã£Á≥ªÁªü","content":"Âë®Êú´Ëä±‰∫Ü‰∏§Â§©ÂÅö‰∫Ü‰∏™Â∞èÈ°πÁõÆÔºöÂü∫‰∫éÈ¢úËâ≤ÁöÑËá™Âä®ÂàÜÊã£Á≥ªÁªü„ÄÇ\n\nÊû∂ÊûÑÔºöÊëÑÂÉèÂ§¥ÔºàUSBÔºâ‚Üí PC‰∏äOpenCVËØÜÂà´È¢úËâ≤ ‚Üí ‰∏≤Âè£ÂèëÊåá‰ª§ÁªôArduino ‚Üí ArduinoÊéßÂà∂ËàµÊú∫Êé®Âä®ÂàÜÊã£Êå°Êùø\n\nÊïàÊûúÔºöËÉΩÂå∫ÂàÜÁ∫¢/Áªø/Ëìù/ÈªÑÂõõÁßçÈ¢úËâ≤ÁöÑÂ∞èÁêÉÔºåÂàÜÊã£ÈÄüÂ∫¶Á∫¶2Áßí/‰∏™ÔºåÂáÜÁ°ÆÁéá95%‰ª•‰∏äÔºàÂÖâÁÖßÁ®≥ÂÆöÊó∂Ôºâ„ÄÇ\n\nÊúÄÂ§ßÁöÑÂùëÊòØÂÖâÁÖßÂèòÂåñÂØπÈ¢úËâ≤ËØÜÂà´ÁöÑÂΩ±ÂìçÔºåÊúÄÂêéÁî®HSVÁ©∫Èó¥+Ëá™ÈÄÇÂ∫îÈòàÂÄºËß£ÂÜ≥ÁöÑ„ÄÇ","post_type":"showcase","tags":["Arduino","OpenCV","ËßÜËßâ","È°πÁõÆ"]},
  {"title":"ÊàëÁöÑÂàõÂÆ¢Â∑•‰ΩúÂè∞Â∏ÉÁΩÆÂàÜ‰∫´ÔºöÂ∞èÁ©∫Èó¥Â§ßÊïàÁéá","content":"Âú®1.5m√ó0.8mÁöÑ‰π¶Ê°å‰∏äÂ∏ÉÁΩÆ‰∫ÜÂÆåÊï¥ÁöÑÂàõÂÆ¢Â∑•‰ΩúÂè∞Ôºö\n\nÂàÜÂå∫ËßÑÂàíÔºöÂ∑¶‰æß3DÊâìÂç∞Êú∫ÔºàÊãìÁ´πP2SÔºâÔºå‰∏≠Èó¥ÁÑäÊé•Âå∫ÔºàÂ∏¶ÊéíÁÉüÈ£éÊâáÔºâÔºåÂè≥‰æßÁîµËÑë+Á§∫Ê≥¢Âô®Ôºå‰∏äÊñπÂ∑•ÂÖ∑ÊåÇÊùø„ÄÇ\n\nÊî∂Á∫≥ÊäÄÂ∑ßÔºöÈõ∂‰ª∂ÁõíÁî®Ê†áÁ≠æÊú∫Ê†áÊ≥®ÔºåÂ∏∏Áî®Â∑•ÂÖ∑3DÊâìÂç∞‰∏ìÁî®ÊîØÊû∂ÔºåÁ∫øÊùêÁî®ÂØÜÂ∞ÅÁÆ±+Âπ≤Áá•ÂâÇ‰øùÂ≠ò„ÄÇ\n\nÂ∞èÁ©∫Èó¥‰πüËÉΩÈ´òÊïàÂàõ‰ΩúÔºÅÂ§ßÂÆ∂ÁöÑÂ∑•‰ΩúÂè∞ÊòØÊÄé‰πàÂ∏ÉÁΩÆÁöÑÔºü","post_type":"showcase","tags":["Â∑•‰ΩúÂè∞","Êî∂Á∫≥","makerÁîüÊ¥ª"]},
  {"title":"ËÅäËÅäAI Agent‰∏éÁâ©ÁêÜ‰∏ñÁïå‰∫§‰∫íÁöÑÊú™Êù•","content":"ÊúÄËøëÂú®ÊÄùËÄÉÔºöÂΩìAI AgentËÉΩÂ§üÊìç‰ΩúÁâ©ÁêÜËÆæÂ§áÊó∂Ôºå‰ºöÂ∏¶Êù•Âì™‰∫õÂèòÈù©Ôºü\n\nÁü≠ÊúüÔºà1-2Âπ¥ÔºâÔºöÊô∫ËÉΩÂÆ∂Â±ÖÁúüÊ≠£Êô∫ËÉΩÂåñÔºåÂÆûÈ™åÂÆ§Ëá™Âä®ÂåñÔºåÁÆÄÂçïÁâ©ÊµÅÂàÜÊã£„ÄÇ\n‰∏≠ÊúüÔºà3-5Âπ¥ÔºâÔºö‰∏™‰∫∫Âä©ÁêÜÊú∫Âô®‰∫∫ÔºåÂÜú‰∏öËá™Âä®ÂåñÔºåÂª∫Á≠ëÊñΩÂ∑•ËæÖÂä©„ÄÇ\n\nÊ†∏ÂøÉÊåëÊàòÔºöÂÆâÂÖ®ÊÄßÔºàAIÊéßÂà∂Áâ©ÁêÜËÆæÂ§áÁöÑÈ£éÈô©Ôºâ„ÄÅÊ≥õÂåñËÉΩÂäõÔºàÊØè‰∏™Âú∫ÊôØÈÉΩ‰∏çÂêåÔºâ„ÄÅÊàêÊú¨Ôºà‰º†ÊÑüÂô®ÂíåÊâßË°åÂô®‰ªçÁÑ∂ÊòÇË¥µÔºâ„ÄÇ\n\nRealWorldClawÂ∞±ÊòØÂú®Ëøô‰∏™ÊñπÂêë‰∏äÁöÑ‰∏Ä‰∏™Â∞èÂ∞èÊé¢Á¥¢„ÄÇ‰Ω†‰ª¨ËßâÂæóËøòÊúâÂì™‰∫õÊúâË∂£ÁöÑÂ∫îÁî®Âú∫ÊôØÔºü","post_type":"discussion","tags":["AI","Agent","Êú™Êù•","ËÆ®ËÆ∫"]}
]

selected = random.sample(posts, min(count, len(posts)))

for i, post in enumerate(selected):
    title = post['title']
    if dry_run:
        print(f"[DRY-RUN] Would post: {title}")
        continue
    
    payload = json.dumps(post).encode('utf-8')
    req = urllib.request.Request(
        f"{api}/community/posts",
        data=payload,
        headers={
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }
    )
    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            result = json.loads(resp.read())
            post_id = result.get('id', 'unknown')
            print(f'OK: Posted "{title}" ‚Üí id={post_id}')
    except Exception as e:
        print(f'ERROR: Failed to post "{title}": {e}')
    
    if i < len(selected) - 1:
        time.sleep(2)
PYEOF
}

main() {
  log "=== Starting community-post.sh (count=$COUNT, dry_run=$DRY_RUN) ==="

  local token="dry-run-token"
  if ! $DRY_RUN; then
    token=$(login) || { log "FATAL: cannot login"; exit 1; }
    log "Logged in successfully"
  fi

  run_posts "$token" 2>&1 | tee -a "$LOG_FILE"
  log "=== Done ==="
}

main
